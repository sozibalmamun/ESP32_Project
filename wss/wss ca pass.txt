Bag Attributes
    localKeyID: A4 10 89 F2 D7 57 B9 5A 9B AC 26 B8 4E 53 25 88 C2 E9 D6 DF 
    friendlyName: grozziieget.zjweiting.com
subject=CN = grozziieget.zjweiting.com

issuer=C = CN, O = "TrustAsia Technologies, Inc.", CN = TrustAsia RSA DV TLS CA G2

-----BEGIN CERTIFICATE-----
MIIGfzCCBOegAwIBAgIRANBUG6rsL5QvgWixLuHWMVcwDQYJKoZIhvcNAQEMBQAw
WTELMAkGA1UEBhMCQ04xJTAjBgNVBAoTHFRydXN0QXNpYSBUZWNobm9sb2dpZXMs
IEluYy4xIzAhBgNVBAMTGlRydXN0QXNpYSBSU0EgRFYgVExTIENBIEcyMB4XDTIz
MTEyMDAwMDAwMFoXDTI0MTExOTIzNTk1OVowJDEiMCAGA1UEAxMZZ3JvenppaWVn
ZXQuemp3ZWl0aW5nLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
AKiNfh80wv6vspWnJtj1aDff8/5jIy2L/SZU3hye3xyleASlFh1ARVUNWBWeoajJ
1eB5AwwsXtz1CtS+ZYOYUzsnhEokMzO3Ae+3EipgUbNZGwMKTq3MJF+EMOACUBIM
szxbF4VUHZMRyJ9BdvlC1be2IkfNY3CFnGyW+RO63hHxl/MR+L7qIacZQWetl/Aq
6bcgzG+dH5QocXyOpd/Zi4UXHme0IuInYEqPEto4HE5W0Z9iq0XCWgAXzl5Hfo2N
L5+57QZEf1dBHBhCqk6oIoxEaE3K95T8iVeW584j+vbd8iTdDIwBUOzqJbHSHVP1
HZg1uFODCeCYxhouY5NRZbsCAwEAAaOCAvUwggLxMB8GA1UdIwQYMBaAFF86fBEQ
fgxncWHci6O1AANn9VccMB0GA1UdDgQWBBQRtVDPMqfYxoD/l92X3uGqFiKe+jAO
BgNVHQ8BAf8EBAMCBaAwDAYDVR0TAQH/BAIwADAdBgNVHSUEFjAUBggrBgEFBQcD
AQYIKwYBBQUHAwIwSQYDVR0gBEIwQDA0BgsrBgEEAbIxAQICMTAlMCMGCCsGAQUF
BwIBFhdodHRwczovL3NlY3RpZ28uY29tL0NQUzAIBgZngQwBAgEwfQYIKwYBBQUH
AQEEcTBvMEIGCCsGAQUFBzAChjZodHRwOi8vY3J0LnRydXN0LXByb3ZpZGVyLmNu
L1RydXN0QXNpYVJTQURWVExTQ0FHMi5jcnQwKQYIKwYBBQUHMAGGHWh0dHA6Ly9v
Y3NwLnRydXN0LXByb3ZpZGVyLmNuMCQGA1UdEQQdMBuCGWdyb3p6aWllZ2V0Lnpq
d2VpdGluZy5jb20wggGABgorBgEEAdZ5AgQCBIIBcASCAWwBagB3AHb/iD8KtvuV
UcJhzPWHujS0pM27KdxoQgqf5mdMWjp0AAABi+wMtZcAAAQDAEgwRgIhAP4l2Kce
6/yN7E7BsKlvpKPZZmui2rG6R8lSXZZn2iUmAiEAiRlZGSZcOUUiGorK9I3NAOfO
QCbOGmUsC6qq9si5oNAAdgA/F0tP1yJHWJQdZRyEvg0S7ZA3fx+FauvBvyiF7Phk
bgAAAYvsDLW+AAAEAwBHMEUCIQCO1IlqWnHfHmdw9M8XpITVH5a0jgJ2PqDdulLh
X6LndQIgWlf8A5RYpOxGjzAilH/AZPMXXGM2eCE0bD+/Ubaao18AdwDuzdBk1dsa
zsVct520zROiModGfLzs3sNRSFlGcR+1mwAAAYvsDLXEAAAEAwBIMEYCIQCTVnVd
gKYWftOgTtikYkHyQFA8b4l7F48PS2pIaxWwXAIhAMLau0syoJx1iNmteK3HVx2t
Zn44Dzosudtr+oX/ruCBMA0GCSqGSIb3DQEBDAUAA4IBgQAcneTRxTtzc+uFOUbf
NkwfoC9DYvpnMEsI1+IZs+d61+HyuLf2Pz7a7v+B9sQoxmCpjcpyV+OnE+nUHWbu
QKW4fI3/jUemf7kL2mCNmB/6Y4He2NgV5asPCONDgoK4yBFAvu2kEJy7kZ4L5iUv
VBjY8yJ2PiHWZlg/RWzO6WtSsnIMsnE2VyK+EbwUy4bt0pg2nt7A8YGoMZePMLSV
RbnTO8WENPN0ZhgJSuNlZWxfgEOEpmNB5JolTZJ1zhlF26596r2JQsIKl+rclsQY
gYvuDpOvmkRShlV3StvL7EnQjqgeTHX1N4f7yNMZaknvckKvTpW33Isx1qCzmPMP
6rRs7hEiIG1hoNhWKD7qKQ2gGRbMEpL75vSbEhjaE9ALtKZS4Lf6kxveiOk7bayy
ykRzoroVoVvb0l+6jnrVk0k/JtPr5rpSODkapZnULmJ4AlWg4Sw+kYm5VH5ikWYX
nfNHym2WCP0nCaCcJ7RuujQSnRlXPc+EyB2K1fSF8m9Cf0U=
-----END CERTIFICATE-----
Bag Attributes: <No Attributes>
subject=C = CN, O = "TrustAsia Technologies, Inc.", CN = TrustAsia RSA DV TLS CA G2

issuer=C = GB, ST = Greater Manchester, L = Salford, O = Comodo CA Limited, CN = AAA Certificate Services

-----BEGIN CERTIFICATE-----
MIIFBzCCA++gAwIBAgIRALIM7VUuMaC/NDp1KHQ76aswDQYJKoZIhvcNAQELBQAw
ezELMAkGA1UEBhMCR0IxGzAZBgNVBAgMEkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4G
A1UEBwwHU2FsZm9yZDEaMBgGA1UECgwRQ29tb2RvIENBIExpbWl0ZWQxITAfBgNV
BAMMGEFBQSBDZXJ0aWZpY2F0ZSBTZXJ2aWNlczAeFw0yMjAxMTAwMDAwMDBaFw0y
ODEyMzEyMzU5NTlaMFkxCzAJBgNVBAYTAkNOMSUwIwYDVQQKExxUcnVzdEFzaWEg
VGVjaG5vbG9naWVzLCBJbmMuMSMwIQYDVQQDExpUcnVzdEFzaWEgUlNBIERWIFRM
UyBDQSBHMjCCAaIwDQYJKoZIhvcNAQEBBQADggGPADCCAYoCggGBAKjGDe0GSaBs
Yl/VhMaTM6GhfR1TAt4mrhN8zfAMwEfLZth+N2ie5ULbW8YvSGzhqkDhGgSBlafm
qq05oeESrIJQyz24j7icGeGyIZ/jIChOOvjt4M8EVi3O0Se7E6RAgVYcX+QWVp5c
Sy+l7XrrtL/pDDL9Bngnq/DVfjCzm5ZYUb1PpyvYTP7trsV+yYOCNmmwQvB4yVjf
IIpHC1OcsPBntMUGeH1Eja4D+qJYhGOxX9kpa+2wTCW06L8T6OhkpJWYn5JYiht5
8exjAR7b8Zi3DeG9oZO5o6Qvhl3f8uGU8lK1j9jCUN/18mI/5vZJ76i+hsgdlfZB
Rh5lmAQjD80M9TY+oD4MYUqB5XrigPfFAUwXFGehhlwCVw7y6+5kpbq/NpvM5Ba8
SeQYUUuMA8RXpTtGlrrTPqJryfa55hTuX/ThhX4gcCVkbyujo0CYr+Uuc14IOyNY
1fD0/qORbllbgV41wiy/2ZUWZQUodqHWkjT1CwIMbQOY5jmrSYGBwwIDAQABo4IB
JjCCASIwHwYDVR0jBBgwFoAUoBEKIz6W8Qfs4q8p74Klf9AwpLQwHQYDVR0OBBYE
FF86fBEQfgxncWHci6O1AANn9VccMA4GA1UdDwEB/wQEAwIBhjASBgNVHRMBAf8E
CDAGAQH/AgEAMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAiBgNVHSAE
GzAZMA0GCysGAQQBsjEBAgIxMAgGBmeBDAECATBDBgNVHR8EPDA6MDigNqA0hjJo
dHRwOi8vY3JsLmNvbW9kb2NhLmNvbS9BQUFDZXJ0aWZpY2F0ZVNlcnZpY2VzLmNy
bDA0BggrBgEFBQcBAQQoMCYwJAYIKwYBBQUHMAGGGGh0dHA6Ly9vY3NwLmNvbW9k
b2NhLmNvbTANBgkqhkiG9w0BAQsFAAOCAQEAHMUom5cxIje2IiFU7mOCsBr2F6CY
eU5cyfQ/Aep9kAXYUDuWsaT85721JxeXFYkf4D/cgNd9+hxT8ZeDOJrn+ysqR7NO
2K9AdqTdIY2uZPKmvgHOkvH2gQD6jc05eSPOwdY/10IPvmpgUKaGOa/tyygL8Og4
3tYyoHipMMnS4OiYKakDJny0XVuchIP7ZMKiP07Q3FIuSS4omzR77kmc75/6Q9dP
v4wa90UCOn1j6r7WhMmX3eT3Gsdj3WMe9bYD0AFuqa6MDyjIeXq08mVGraXiw73s
Zale8OMckn/BU3O/3aFNLHLfET2H2hT6Wb3nwxjpLIfXmSVcVd8A58XH0g==
-----END CERTIFICATE-----
Bag Attributes
    localKeyID: A4 10 89 F2 D7 57 B9 5A 9B AC 26 B8 4E 53 25 88 C2 E9 D6 DF 
    friendlyName: grozziieget.zjweiting.com
Key Attributes: <No Attributes>
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCojX4fNML+r7KV
pybY9Wg33/P+YyMti/0mVN4cnt8cpXgEpRYdQEVVDVgVnqGoydXgeQMMLF7c9QrU
vmWDmFM7J4RKJDMztwHvtxIqYFGzWRsDCk6tzCRfhDDgAlASDLM8WxeFVB2TEcif
QXb5QtW3tiJHzWNwhZxslvkTut4R8ZfzEfi+6iGnGUFnrZfwKum3IMxvnR+UKHF8
jqXf2YuFFx5ntCLiJ2BKjxLaOBxOVtGfYqtFwloAF85eR36NjS+fue0GRH9XQRwY
QqpOqCKMRGhNyveU/IlXlufOI/r23fIk3QyMAVDs6iWx0h1T9R2YNbhTgwngmMYa
LmOTUWW7AgMBAAECggEAIMSpQV3bjvIPcQK3DbTgFwTGBa22WBOAGqSjLcNBMuuE
YrrJitRE5l0aw9E8MnlSyDoeeo5hvukwut1tFOFXRQfQsy1IewRYLwdTU8O3/nsT
QksNssIeTCeB7PrmICwx6Ej5UKVivoXVkAiFHb59mCKjlXv7mhOPrpjHQauxoqEZ
fqrdYe/zFFHExMf5RSDDXW1OjuHTmbxvSUyZP/7/2LG/HzZPHpjfyQy8Z/fuMu/2
/0Yn2UtlwB3ERphhyCUk1f9JYZTFY+y+lDii1vD+nW6bvgpAXC4YFoy7WPdQp4KA
fFw7MHnask1t3mIAAxpKyN/5cWw/imjPAsBo503S0QKBgQDanFmrj2O0H9lkh/j0
Fvw6QO8Kd0Qk+n+Zj5F8SXHknFMvm7D2+kTG7uYxnxpEjFcTTpuSfDPnwFWdOleZ
i1ayvTvCyV342bQgl2KCaPLcNDh2QaMFBXzO2ZFqksyuP0eDxNyZ3CuvNP/ZAKVG
DgwBtsIXjgEbm8UQX09wRPCsyQKBgQDFYWbnwxlDq4UKNjrG/QG/l51vL0sLhumU
14MhBCAqZsY6H/2o0s7haWR+1+R5m0HUT+khmVRG+rW/KvTPRybvwFpfWGd69qBI
BEwNTZw/kGwLgwtOt3lfs25lEQM9Y9alsVejjtdvw9kEOMho+4/R0OFOpR/cAvTV
i5/tQ5f0YwKBgQDBU4WFT8BHmebhndHO4sjaJ3R+F+0empzfS3TIqhbbqldygcgl
EjxihQDznxVWy5lxzJGOIOKyL4hHDEJN2kiotuqznurI2JYQQHBwjalAjbnk8rTd
CvZN42BTFFGIQxPWdvDz7B6Bymf8GzMN2fxKQ7ovpHhcVwwWJ4OT8JO66QKBgC+U
WTAJEbAESp+5jtWk66T5sVO5/McckHX2tX9h9TcDa0lbqNPnbUNdGoKRHFxMFsRN
Nw+IXI53pRQeEMFej34/ygkt0FQN23lAv+x9BuszrzffMPyascFmCXiHb1Z/GKD8
bPnaVwh0F34zCex0p6iWR5mjqFhqxgYsEDMrlhetAoGAFNrc3TfEhbM/sC6cqkA4
ngdCgRZZBoiNWmNSNzBbju7RTVrfx1vaDVvuFzhlKjqE8CDwoiFXhx2H8HqQQjg/
K3bW+yzmLjYYM3M6AIrw6/4ONy0YFguTD0ZFcraSYZxxz4iKiNwdbQc9BByz0mc0
/ViAC7tXPf6KPOiugXuUcrI=
-----END PRIVATE KEY-----






#include <stdio.h>
#include "esp_wifi.h"
#include "esp_system.h"
#include "nvs_flash.h"
#include "esp_event.h"
#include "protocol_examples_common.h"

#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/semphr.h"
#include "freertos/event_groups.h"

#include "esp_log.h"
#include "esp_websocket_client.h"
#include "esp_event.h"
#include "esp_tls.h"

#define NO_DATA_TIMEOUT_SEC 5

static const char *TAG = "MQTTWSS_EXAMPLE";

#define test "wss://echo.websocket.org/"

const char echo_org_ssl_ca_cert[]  = \
"-----BEGIN CERTIFICATE-----\n" \
"MIIEZTCCA02gAwIBAgIQQAF1BIMUpMghjISpDBbN3zANBgkqhkiG9w0BAQsFADA/\n" \
"MSQwIgYDVQQKExtEaWdpdGFsIFNpZ25hdHVyZSBUcnVzdCBDby4xFzAVBgNVBAMT\n" \
"DkRTVCBSb290IENBIFgzMB4XDTIwMTAwNzE5MjE0MFoXDTIxMDkyOTE5MjE0MFow\n" \
"MjELMAkGA1UEBhMCVVMxFjAUBgNVBAoTDUxldCdzIEVuY3J5cHQxCzAJBgNVBAMT\n" \
"AlIzMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuwIVKMz2oJTTDxLs\n" \
"jVWSw/iC8ZmmekKIp10mqrUrucVMsa+Oa/l1yKPXD0eUFFU1V4yeqKI5GfWCPEKp\n" \
"Tm71O8Mu243AsFzzWTjn7c9p8FoLG77AlCQlh/o3cbMT5xys4Zvv2+Q7RVJFlqnB\n" \
"U840yFLuta7tj95gcOKlVKu2bQ6XpUA0ayvTvGbrZjR8+muLj1cpmfgwF126cm/7\n" \
"gcWt0oZYPRfH5wm78Sv3htzB2nFd1EbjzK0lwYi8YGd1ZrPxGPeiXOZT/zqItkel\n" \
"/xMY6pgJdz+dU/nPAeX1pnAXFK9jpP+Zs5Od3FOnBv5IhR2haa4ldbsTzFID9e1R\n" \
"oYvbFQIDAQABo4IBaDCCAWQwEgYDVR0TAQH/BAgwBgEB/wIBADAOBgNVHQ8BAf8E\n" \
"BAMCAYYwSwYIKwYBBQUHAQEEPzA9MDsGCCsGAQUFBzAChi9odHRwOi8vYXBwcy5p\n" \
"ZGVudHJ1c3QuY29tL3Jvb3RzL2RzdHJvb3RjYXgzLnA3YzAfBgNVHSMEGDAWgBTE\n" \
"p7Gkeyxx+tvhS5B1/8QVYIWJEDBUBgNVHSAETTBLMAgGBmeBDAECATA/BgsrBgEE\n" \
"AYLfEwEBATAwMC4GCCsGAQUFBwIBFiJodHRwOi8vY3BzLnJvb3QteDEubGV0c2Vu\n" \
"Y3J5cHQub3JnMDwGA1UdHwQ1MDMwMaAvoC2GK2h0dHA6Ly9jcmwuaWRlbnRydXN0\n" \
"LmNvbS9EU1RST09UQ0FYM0NSTC5jcmwwHQYDVR0OBBYEFBQusxe3WFbLrlAJQOYf\n" \
"r52LFMLGMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjANBgkqhkiG9w0B\n" \
"AQsFAAOCAQEA2UzgyfWEiDcx27sT4rP8i2tiEmxYt0l+PAK3qB8oYevO4C5z70kH\n" \
"ejWEHx2taPDY/laBL21/WKZuNTYQHHPD5b1tXgHXbnL7KqC401dk5VvCadTQsvd8\n" \
"S8MXjohyc9z9/G2948kLjmE6Flh9dDYrVYA9x2O+hEPGOaEOa1eePynBgPayvUfL\n" \
"qjBstzLhWVQLGAkXXmNs+5ZnPBxzDJOLxhF2JIbeQAcH5H0tZrUlo5ZYyOqA7s9p\n" \
"O5b85o3AM/OJ+CktFBQtfvBhcJVd9wvlwPsk+uyOy2HI7mNxKKgsBTt375teA2Tw\n" \
"UdHkhVNcsAKX1H7GNNLOEADksd86wuoXvg==\n" \
"-----END CERTIFICATE-----\n";

static TimerHandle_t shutdown_signal_timer;
static SemaphoreHandle_t shutdown_sema;

static void shutdown_signaler(TimerHandle_t xTimer)
{
    ESP_LOGI(TAG, "No data received for %d seconds, signaling shutdown", NO_DATA_TIMEOUT_SEC);
    xSemaphoreGive(shutdown_sema);
}

static void websocket_event_handler(void *handler_args, esp_event_base_t base, int32_t event_id, void *event_data)
{
    esp_websocket_event_data_t *data = (esp_websocket_event_data_t *)event_data;
    switch (event_id) {
    case WEBSOCKET_EVENT_CONNECTED:
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_CONNECTED");
        break;
    case WEBSOCKET_EVENT_DISCONNECTED:
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_DISCONNECTED");
        break;
    case WEBSOCKET_EVENT_DATA:
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_DATA");
        ESP_LOGI(TAG, "Received opcode=%d", data->op_code);
        if (data->op_code == 0x08 && data->data_len == 2) {
            ESP_LOGW(TAG, "Received closed message with code=%d", 256*data->data_ptr[0] + data->data_ptr[1]);
        } else {
            ESP_LOGW(TAG, "Received=%.*s", data->data_len, (char *)data->data_ptr);
        }
        ESP_LOGW(TAG, "Total payload length=%d, data_len=%d, current payload offset=%d\r\n", data->payload_len, data->data_len, data->payload_offset);

        xTimerReset(shutdown_signal_timer, portMAX_DELAY);
        break;
    case WEBSOCKET_EVENT_ERROR:
        ESP_LOGI(TAG, "WEBSOCKET_EVENT_ERROR");
        break;
    }
}

static void websocket_app_start(void)
{
    esp_websocket_client_config_t websocket_cfg = {};

    shutdown_signal_timer = xTimerCreate("Websocket shutdown timer", NO_DATA_TIMEOUT_SEC * 1000 / portTICK_PERIOD_MS,
                                         pdFALSE, NULL, shutdown_signaler);
    shutdown_sema = xSemaphoreCreateBinary();

    websocket_cfg.uri = test;
    websocket_cfg.cert_pem = echo_org_ssl_ca_cert;

    ESP_LOGI(TAG, "Initializing global CA store...");
    ESP_ERROR_CHECK(esp_tls_set_global_ca_store((const unsigned char *)echo_org_ssl_ca_cert, sizeof(echo_org_ssl_ca_cert)));

    websocket_cfg.use_global_ca_store = true;
    websocket_cfg.skip_cert_common_name_check = true;  // Disable certificate common name check
    websocket_cfg.disable_auto_reconnect = false;

    ESP_LOGI(TAG, "Connecting to %s...", websocket_cfg.uri);

    esp_websocket_client_handle_t client = esp_websocket_client_init(&websocket_cfg);
    esp_websocket_register_events(client, WEBSOCKET_EVENT_ANY, websocket_event_handler, (void *)client);

    esp_websocket_client_start(client);
    xTimerStart(shutdown_signal_timer, portMAX_DELAY);
    char data[32];
    int i = 0;
    while (i < 5) {
        if (esp_websocket_client_is_connected(client)) {
            int len = sprintf(data, "hello %04d", i++);
            ESP_LOGI(TAG, "Sending %s", data);
            esp_websocket_client_send_text(client, data, len, portMAX_DELAY);
        }
        vTaskDelay(1000 / portTICK_RATE_MS);
    }

    xSemaphoreTake(shutdown_sema, portMAX_DELAY);
    esp_websocket_client_close(client, portMAX_DELAY);
    ESP_LOGI(TAG, "Websocket Stopped");
    esp_websocket_client_destroy(client);
}

void app_main(void)
{
    ESP_LOGI(TAG, "[APP] Startup..");
    ESP_LOGI(TAG, "[APP] Free memory: %d bytes", esp_get_free_heap_size());
    ESP_LOGI(TAG, "[APP] IDF version: %s", esp_get_idf_version());
    esp_log_level_set("*", ESP_LOG_INFO);
    esp_log_level_set("WEBSOCKET_CLIENT", ESP_LOG_DEBUG);
    esp_log_level_set("TRANSPORT_WS", ESP_LOG_DEBUG);
    esp_log_level_set("TRANS_TCP", ESP_LOG_DEBUG);

    ESP_ERROR_CHECK(nvs_flash_init());
    ESP_ERROR_CHECK(esp_netif_init());
    ESP_ERROR_CHECK(esp_event_loop_create_default());

    ESP_ERROR_CHECK(example_connect());

    websocket_app_start();
}
